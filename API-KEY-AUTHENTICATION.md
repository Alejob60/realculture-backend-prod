# API Key Authentication System

## Overview
This document describes the implementation of API Key authentication for the Misy CLI to securely access the MisyBot backend without exposing user credentials.

## Components

### 1. ApiKey Entity
The `ApiKeyEntity` represents an API key in the system:
- `id`: UUID primary key
- `key`: Unique string identifier for the API key
- `userId`: Foreign key to the User entity
- `createdAt`: Timestamp when the key was created
- `expiresAt`: Optional expiration timestamp
- `revoked`: Boolean flag indicating if the key has been revoked

### 2. ApiKey Service
The `ApiKeyService` handles the generation, validation, and management of API keys:
- `generateForUser(userId)`: Creates a new API key for a user
- `validate(key)`: Validates an API key and returns the associated user
- `revokeApiKey(key)`: Revokes an API key
- `listApiKeysForUser(userId)`: Lists all active API keys for a user

### 3. ApiKey Controller
The `ApiKeyController` provides endpoints for managing API keys:
- `POST /auth/api-key/generate`: Generate a new API key (JWT required)
- `GET /auth/api-key/list`: List all API keys for the current user (JWT required)
- `DELETE /auth/api-key/revoke/:key`: Revoke an API key (JWT required)

### 4. ApiKey Guard
The `ApiKeyGuard` is a NestJS guard that validates API keys:
- Extracts the API key from the `x-api-key` header
- Validates the key using the `ApiKeyService`
- Attaches the user to the request object

### 5. Config Controller
The `ConfigController` provides secure configuration data to the CLI:
- `GET /config`: Returns configuration data (API Key required)

## Usage Flow

### 1. Generate API Key
A user with a valid JWT can generate an API key:
```bash
curl -X POST http://localhost:3001/auth/api-key/generate \
  -H "Authorization: Bearer <JWT_TOKEN>"
```

Response:
```json
{
  "apiKey": "generated_api_key_string"
}
```

### 2. Use API Key
The CLI can use the API key to access protected endpoints:
```bash
curl -X GET http://localhost:3001/config \
  -H "x-api-key: generated_api_key_string"
```

Response:
```json
{
  "aiServiceUrl": "https://ai.misy.ai",
  "apiEndpoint": "https://api.misy.ai/v1",
  "dbUrl": "mongodb://internal.misy.ai:27017/context",
  "telemetry": "https://telemetry.misy.ai/v1"
}
```

## Security Considerations

1. **Key Generation**: API keys are generated using cryptographically secure random bytes
2. **Key Storage**: Keys are stored in the database but not encrypted (this could be enhanced)
3. **Key Revocation**: Keys can be revoked to immediately invalidate access
4. **Key Expiration**: Keys can have expiration dates for additional security
5. **Header-based Authentication**: Keys are passed in headers, not URLs, to prevent logging

## Database Migration

A migration file (`1760500000000-CreateApiKeysTable.ts`) has been created to add the `api_keys` table to the database schema.

## Integration with Existing Auth System

The API Key authentication system works alongside the existing JWT-based authentication:
- Users can authenticate with either JWT tokens or API keys
- API keys are generated by authenticated users with JWT tokens
- Both authentication methods attach the user object to the request

## Future Enhancements

1. **Key Encryption**: Store API keys encrypted in the database
2. **Rate Limiting**: Implement rate limiting for API key usage
3. **Scopes**: Add scopes to API keys to limit their permissions
4. **Key Rotation**: Implement automatic key rotation for enhanced security